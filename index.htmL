<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Abrechnung</title>

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f4f6f8;margin:0;padding:16px;}
    .wrap{max-width:900px;margin:0 auto;}
    h1{margin:0 0 12px 0;}
    .card{background:#fff;border:1px solid #e6e8ec;border-radius:12px;padding:14px;margin:12px 0;box-shadow:0 1px 2px rgba(0,0,0,.04);}
    .row{display:flex;gap:10px;align-items:center;margin:8px 0;}
    .row label{min-width:140px;font-weight:600;}
    .row input,.row textarea{flex:1;border:1px solid #d7dbe2;border-radius:10px;padding:10px;font-size:14px;}
    .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .muted{color:#64748b;font-size:13px}
    .btn{cursor:pointer;border:0;border-radius:12px;padding:12px 14px;font-weight:700}
    .btn-primary{background:#111827;color:#fff}
    .btn-secondary{background:#e5e7eb;color:#111827}
    .right{display:flex;justify-content:flex-end;gap:10px}
    #signature-pad{border:1px dashed #cbd5e1;border-radius:12px;background:#fafafa;width:100%;height:180px;touch-action:none;}
    .small{font-size:12px}
    .ok{color:#059669;font-weight:700}
    .err{color:#dc2626;font-weight:700}
    .table-head{display:grid;grid-template-columns:50px 1fr 200px;gap:10px;margin-bottom:8px;font-weight:800;color:#334155}
    .line{display:grid;grid-template-columns:50px 1fr 200px;gap:10px;margin:8px 0}
    .line span{display:flex;align-items:center;justify-content:center;background:#f1f5f9;border:1px solid #e2e8f0;border-radius:10px}
    .line input{width:100%}
    @media (max-width:700px){
      .grid3{grid-template-columns:1fr}
      .table-head,.line{grid-template-columns:40px 1fr 160px}
      .row label{min-width:110px}
    }
  </style>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>

<body>
  <div class="wrap" id="pdf-content">
    <h1>Abrechnung</h1>
    <div class="muted">Bitte Formular ausfüllen und senden.</div>

    <div class="card">
      <div class="grid3">
        <div>
          <div class="muted small">Datum</div>
          <input id="datum" type="date" />
        </div>
        <div>
          <div class="muted small">Fahrer</div>
          <input id="fahrer" placeholder="Name" />
        </div>
        <div>
          <div class="muted small">Kennzeichen</div>
          <input id="kennzeichen" placeholder="z.B. AB-1234" />
        </div>
      </div>
    </div>

    <div class="card">
      <strong>Income</strong>
      <div class="muted small">Bis zu 15 Positionen</div>

      <div style="margin-top:10px">
        <div class="table-head">
          <div>#</div>
          <div>Company</div>
          <div>Betrag (€)</div>
        </div>
        <div id="zeilen-container"></div>
      </div>

      <hr style="border:0;border-top:1px solid #eef2f7;margin:14px 0"/>

      <div class="row">
        <label>Sum Income</label>
        <input id="incomeSum" readonly />
      </div>
    </div>

    <div class="card">
      <strong>Ausgaben</strong>
      <div class="row">
        <label>Fuel (-)</label>
        <input id="tanken" type="number" step="0.01" value="0" />
      </div>
      <div class="row">
        <label>Payout (-)</label>
        <input id="auszahlung" type="number" step="0.01" value="0" />
      </div>

      <hr style="border:0;border-top:1px solid #eef2f7;margin:14px 0"/>

      <div class="row">
        <label><strong>Total</strong></label>
        <input id="total" readonly />
      </div>
      <div class="muted small">Total = Sum Income - Fuel - Payout</div>
    </div>

    <div class="card">
      <strong>Notizen</strong>
      <textarea id="notizen" rows="3" placeholder="Optional..."></textarea>
    </div>

    <div class="card">
      <strong>Signature</strong><br/>
      <canvas id="signature-pad"></canvas>
      <div class="right" style="margin-top:10px">
        <button class="btn btn-secondary" type="button" onclick="clearCanvas()">Clear</button>
      </div>
    </div>

    <div class="card">
      <div class="right">
        <button class="btn btn-primary" type="button" onclick="submitForm()">Submit & Send</button>
      </div>
      <div id="status" class="muted small" style="margin-top:10px"></div>
    </div>
  </div>

  <script>
    /******************** CONFIG ********************/
    // EmailJS public key
    emailjs.init("wnMWzGwyETIhHbBiB");

    const SERVICE_ID  = "service_x5f1og9";
    const TEMPLATE_ID = "template_sr76rb";

    // Google Apps Script (Web App) URL
    const GOOGLE_SCRIPT_URL =
      "https://script.google.com/macros/s/AKfycbzF2heFc1Wf9XZsfLrJjWvhQ5j2BNpwv3ti5_8RzNGQDVCYc2SmVZz-njytBbKw8PGo/exec";

    /******************** INCOME LINES ********************/
    const container = document.getElementById("zeilen-container");
    for (let i = 1; i <= 15; i++) {
      const div = document.createElement("div");
      div.className = "line";
      div.innerHTML = `
        <span>${i}</span>
        <input placeholder="Company" class="company" />
        <input type="number" step="0.01" value="0" class="betrag" />
      `;
      container.appendChild(div);
    }

    function num(v){
      const n = parseFloat(v);
      return isNaN(n) ? 0 : n;
    }

    function recalc(){
      const betraege = [...document.querySelectorAll(".betrag")].map(i => num(i.value));
      const sumIncome = betraege.reduce((a,b)=>a+b,0);

      const fuel = num(document.getElementById("tanken").value);
      const payout = num(document.getElementById("auszahlung").value);

      document.getElementById("incomeSum").value = sumIncome.toFixed(2);
      document.getElementById("total").value = (sumIncome - fuel - payout).toFixed(2);
    }

    document.addEventListener("input", (e)=>{
      if(e.target.classList.contains("betrag") || ["tanken","auszahlung"].includes(e.target.id)){
        recalc();
      }
    });
    recalc();

    /******************** SIGNATURE ********************/
    const canvas = document.getElementById("signature-pad");
    const ctx = canvas.getContext("2d");
    let drawing = false;

    function resizeCanvas(){
      const rect = canvas.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      canvas.width = Math.floor(rect.width * dpr);
      canvas.height = Math.floor(rect.height * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
      ctx.lineWidth = 2;
      ctx.lineCap = "round";
      ctx.strokeStyle = "#111827";
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    function getPos(e){
      const r = canvas.getBoundingClientRect();
      const x = (e.touches ? e.touches[0].clientX : e.clientX) - r.left;
      const y = (e.touches ? e.touches[0].clientY : e.clientY) - r.top;
      return {x,y};
    }

    function startDraw(e){
      drawing = true;
      const p = getPos(e);
      ctx.beginPath();
      ctx.moveTo(p.x, p.y);
      e.preventDefault();
    }
    function moveDraw(e){
      if(!drawing) return;
      const p = getPos(e);
      ctx.lineTo(p.x, p.y);
      ctx.stroke();
      e.preventDefault();
    }
    function endDraw(e){
      drawing = false;
      e.preventDefault();
    }

    canvas.addEventListener("mousedown", startDraw);
    canvas.addEventListener("mousemove", moveDraw);
    window.addEventListener("mouseup", endDraw);

    canvas.addEventListener("touchstart", startDraw, {passive:false});
    canvas.addEventListener("touchmove", moveDraw, {passive:false});
    canvas.addEventListener("touchend", endDraw, {passive:false});

    function clearCanvas(){
      const r = canvas.getBoundingClientRect();
      ctx.clearRect(0,0,r.width,r.height);
    }

    function setStatus(msg, type="muted"){
      const el = document.getElementById("status");
      el.className = type === "ok" ? "ok" : type === "err" ? "err" : "muted small";
      el.textContent = msg;
    }

    /******************** SUBMIT ********************/
    async function submitForm(){
      try{
        setStatus("Sending...");

        // basic validation
        const datum = document.getElementById("datum").value;
        const fahrer = document.getElementById("fahrer").value.trim();
        if(!datum || !fahrer){
          setStatus("Bitte Datum und Fahrer ausfüllen.", "err");
          return;
        }

        // make PDF (screenshot of #pdf-content)
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF("p", "mm", "a4");
        const node = document.getElementById("pdf-content");

        const canvasImg = await html2canvas(node, {scale: 2, useCORS: true});
        const imgData = canvasImg.toDataURL("image/png");

        const pageWidth = 210;
        const imgWidth = pageWidth;
        const imgHeight = canvasImg.height * imgWidth / canvasImg.width;

        pdf.addImage(imgData, "PNG", 0, 0, imgWidth, imgHeight);
        const pdfBlob = pdf.output("blob");

        // upload PDF to Google Script
        const fd = new FormData();
        fd.append("file", pdfBlob);
        fd.append("filename", `${datum}_${fahrer}.pdf`);

        const res = await fetch(GOOGLE_SCRIPT_URL, { method:"POST", body: fd });
        let data;
        try{
          data = await res.json();
        }catch(e){
          throw new Error("Google Script response is not JSON. Check deployment / permissions.");
        }

        if(!res.ok || !data || !data.url){
          throw new Error("Google Script upload failed. Check script logs.");
        }

        // send email via EmailJS
        const total = document.getElementById("total").value;
        await emailjs.send(SERVICE_ID, TEMPLATE_ID, {
          datum,
          fahrer,
          total,
          pdf_link: data.url
        });

        setStatus("Sent successfully ✅", "ok");
      }catch(err){
        console.error(err);
        setStatus("Send failed ❌  " + (err?.message || err), "err");
      }
    }
  </script>
</body>
</html>

