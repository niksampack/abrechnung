<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>NIK Transport PRO</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root {
      --primary: #1a2a6c;
      --accent: #b21f1f;
      --brand-green: #05B084; /* کد رنگ جدید شما */
      --text-muted: #7f8c8d;
      --card-radius: 20px;
    }

    body { font-family: 'Inter', -apple-system, sans-serif; background: #f4f7f6; margin: 0; padding: 15px; color: #2c3e50; }

    /* هدر با فونت لوکس */
    .header { text-align: center; padding: 25px 0; }
    .header h1 { 
      font-family: 'Times New Roman', serif; 
      font-style: italic;
      font-weight: 300;
      letter-spacing: 4px;
      text-transform: uppercase;
      margin: 0;
      color: var(--primary);
      font-size: 28px;
    }
    .header .subtitle { font-size: 10px; letter-spacing: 2px; color: var(--text-muted); text-transform: uppercase; margin-top: 5px; }

    .card { background: #fff; border-radius: var(--card-radius); padding: 20px; margin-bottom: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.03); border: none; }
    
    /* طراحی ردیفی بخش مشخصات راننده */
    .driver-info-grid { display: flex; flex-direction: column; gap: 15px; margin-top: 10px; }
    .info-item { display: grid; grid-template-columns: 110px 1fr; align-items: center; border-bottom: 1px solid #f8f9fa; padding-bottom: 10px; }
    .info-label { font-size: 13px; color: var(--text-muted); font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
    .info-value input { 
      border: none !important; 
      background: transparent !important; 
      padding: 0 !important; 
      font-weight: 700 !important; 
      color: var(--primary) !important; 
      font-size: 16px !important;
      box-shadow: none !important;
      width: 100%;
    }
    .info-value input::placeholder { font-weight: 400; color: #d1d5db; }

    /* لبه‌های گرد و استایل ورودی‌ها */
    input { 
      width: 100%; padding: 14px; border: 1px solid #edf2f7; border-radius: 12px; 
      font-size: 16px; box-sizing: border-box; background: #f8fafc; transition: 0.3s;
    }
    input:focus { background: #fff; border-color: var(--brand-green); outline: none; box-shadow: 0 0 0 4px rgba(5, 176, 132, 0.1); }

    .row { display: grid; grid-template-columns: 30px 1fr 90px; gap: 12px; margin-bottom: 10px; align-items: center; }
    .row span { color: #cbd5e0; font-weight: 600; font-size: 14px; }

    /* کارت Total با رنگ سبز جدید شما */
    .total-card { background: var(--brand-green); color: white; text-align: center; box-shadow: 0 10px 20px rgba(5, 176, 132, 0.2); }
    .total-card label { color: rgba(255,255,255,0.9); font-size: 11px; text-transform: uppercase; letter-spacing: 1.5px; font-weight: 600; }
    #total { background: transparent; border: none; color: white; font-size: 34px; font-weight: 800; text-align: center; width: 100%; padding: 5px 0; }

    canvas { width: 100%; height: 160px; border: 2px dashed #e2e8f0; border-radius: var(--card-radius); background: #fff; margin-top: 10px; }
    
    .btn-send { 
      width: 100%; padding: 20px; background: var(--primary); color: white; border: none; 
      border-radius: var(--card-radius); font-size: 18px; font-weight: 700; letter-spacing: 1px;
      box-shadow: 0 10px 20px rgba(26,42,108,0.2); cursor: pointer; transition: 0.3s;
    }
    .btn-send:active { transform: scale(0.98); }
    
    .btn-clear { background: #fff; color: var(--accent); border: 1px solid #fee2e2; padding: 10px; border-radius: 10px; width: 100%; margin-top: 10px; font-size: 12px; font-weight: 600; }

    #result { text-align: center; padding: 20px; font-weight: bold; font-size: 16px; }
  </style>
</head>
<body>

<div class="header">
  <h1>Abrechnung</h1>
  <div class="subtitle">NIK Transport Logistic</div>
</div>

<form id="form">
  <input type="hidden" name="access_key" value="817b5739-ed89-4340-9674-57d210b081b7">

  <div class="card">
    <div class="driver-info-grid">
      <div class="info-item">
        <div class="info-label">Name</div>
        <div class="info-value"><input name="fahrer" id="fahrer" type="text" required placeholder="Fahrername eingeben"></div>
      </div>
      <div class="info-item">
        <div class="info-label">Kennzeichen</div>
        <div class="info-value"><input name="auto" id="kennzeichen" type="text" placeholder="SO 000 000"></div>
      </div>
      <div class="info-item" style="border:none">
        <div class="info-label">Datum</div>
        <div class="info-value"><input name="datum" id="datum" type="date"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <strong style="display:block; margin-bottom:15px; font-size:12px; color:var(--text-muted); letter-spacing:1px;">EINNAHMEN DETAILS (CHF)</strong>
    <div id="zeilen"></div>
  </div>

  <div class="card">
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px">
      <div><label style="font-size:10px; color:var(--text-muted); font-weight:600;">SUMME</label><input id="sumIncome" readonly value="0.00"></div>
      <div><label style="font-size:10px; color:var(--text-muted); font-weight:600;">TANKEN</label><input name="tanken" id="tanken" type="number" step="0.05" value="0" oninput="recalc()"></div>
    </div>
    <div style="margin-top:15px">
      <label style="font-size:10px; color:var(--text-muted); font-weight:600;">AUSZAHLUNG AN FAHRER</label><input name="auszahlung" id="auszahlung" type="number" step="0.05" value="0" oninput="recalc()">
    </div>
  </div>

  <div class="card total-card">
    <label>Netto Total</label>
    <input name="total_final" id="total" readonly value="0.00">
  </div>

  <div class="card">
    <strong style="font-size:12px; color:var(--text-muted); letter-spacing:1px;">UNTERSCHRIFT</strong>
    <canvas id="signature"></canvas>
    <button type="button" class="btn-clear" onclick="clearSign()">Löschen</button>
  </div>

  <button class="btn-send" type="submit" id="sendBtn">ABRECHNUNG SENDEN</button>
</form>

<p id="result"></p>

<script>
  // Setup Rows
  const zeilen = document.getElementById("zeilen");
  for(let i=1; i<=15; i++) {
    zeilen.innerHTML += `<div class="row"><span>${i}</span><input name="firma_${i}" id="c_${i}" placeholder="Firma"><input name="betrag_${i}" id="a_${i}" type="number" step="0.05" value="0" oninput="recalc()"></div>`;
  }
  document.getElementById('datum').valueAsDate = new Date();

  function recalc() {
    let sum = 0;
    for(let i=1; i<=15; i++) sum += Number(document.getElementById(`a_${i}`).value || 0);
    document.getElementById("sumIncome").value = sum.toFixed(2);
    let t = Number(document.getElementById("tanken").value || 0);
    let a = Number(document.getElementById("auszahlung").value || 0);
    document.getElementById("total").value = (sum - t - a).toFixed(2);
  }

  // Signature
  const canvas = document.getElementById("signature");
  const ctx = canvas.getContext("2d");
  canvas.width = canvas.offsetWidth; canvas.height = 160;
  ctx.lineWidth = 3; ctx.lineCap = "round"; ctx.strokeStyle = "#1a2a6c";
  
  let drawing = false;
  const getPos = (e) => {
    const rect = canvas.getBoundingClientRect();
    const cx = e.touches ? e.touches[0].clientX : e.clientX;
    const cy = e.touches ? e.touches[0].clientY : e.clientY;
    return { x: cx - rect.left, y: cy - rect.top };
  };

  const startDraw = (e) => { drawing = true; ctx.beginPath(); const p = getPos(e); ctx.moveTo(p.x, p.y); if(e.touches) e.preventDefault(); };
  const moveDraw = (e) => { if(!drawing) return; const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); if(e.touches) e.preventDefault(); };
  
  canvas.addEventListener("touchstart", startDraw, {passive: false});
  canvas.addEventListener("touchmove", moveDraw, {passive: false});
  window.addEventListener("touchend", () => drawing = false);
  canvas.onmousedown = startDraw; canvas.onmousemove = moveDraw;
  function clearSign() { ctx.clearRect(0,0,canvas.width,canvas.height); }

  // Submit Logic
  const form = document.getElementById('form');
  const result = document.getElementById('result');

  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    const btn = document.getElementById("sendBtn");
    btn.disabled = true;
    result.style.color = "var(--primary)";
    result.innerHTML = "Wird gesendet... Bitte warten";

    try {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();
      
      // دیزاین PDF خروجی
      pdf.setFontSize(22); pdf.setTextColor(26, 42, 108);
      pdf.text("NIK Transport Abrechnung", 15, 20);
      
      pdf.setFontSize(12); pdf.setTextColor(0, 0, 0);
      pdf.text(`Fahrer: ${document.getElementById("fahrer").value}`, 15, 35);
      pdf.text(`Auto: ${document.getElementById("kennzeichen").value}`, 15, 42);
      pdf.text(`Datum: ${document.getElementById("datum").value}`, 15, 49);
      pdf.text(`Total: ${document.getElementById("total").value} CHF`, 15, 60);
      
      const sigData = canvas.toDataURL("image/jpeg", 0.5);
      pdf.addImage(sigData, 'JPEG', 15, 70, 60, 30);

      const pdfBlob = pdf.output('blob');
      const formData = new FormData(form);
      formData.append("attachment", pdfBlob, `Abrechnung_${document.getElementById("fahrer").value}.pdf`);

      const resp = await fetch('https://api.web3forms.com/submit', { method: 'POST', body: formData });
      if (resp.ok) {
        result.style.color = "var(--brand-green)";
        result.innerHTML = "Erfolgreich gesendet! ✅";
        form.reset(); clearSign();
        document.getElementById('datum').valueAsDate = new Date();
      } else { 
        result.style.color = "var(--accent)"; 
        result.innerHTML = "Senden fehlgeschlagen."; 
      }
    } catch (err) { 
      result.style.color = "var(--accent)"; 
      result.innerHTML = "Verbindungsfehler!"; 
    }
    finally { btn.disabled = false; }
  });
</script>
</body>
</html>
